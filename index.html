<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Interactive 3D Prague</title>
    <style>
        :root {
            --bg-dark: #121212; --sidebar-bg: #1e1e1e; --primary-accent: #e94560;
            --text-light: #f0f0f0; --text-muted: #a0a0a0; --ground-color: #2a2a2a;
            --building-color: #555555;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100dvh; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-dark); color: var(--text-light); }
        #app-container { display: flex; width: 100%; height: 100%; }
        #sidebar { width: 300px; flex-shrink: 0; background-color: var(--sidebar-bg); display: flex; flex-direction: column; box-shadow: 2px 0 15px rgba(0,0,0,0.5); z-index: 10; }
        #sidebar-header { padding: 20px; border-bottom: 1px solid #333; }
        #sidebar-header h1 { color: var(--primary-accent); font-size: 1.5em; margin-bottom: 5px; }
        #sidebar-header p { color: var(--text-muted); font-size: 0.9em; }
        #locations-list { list-style: none; overflow-y: auto; flex-grow: 1; -webkit-overflow-scrolling: touch; }
        #locations-list li { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #333; transition: background-color 0.2s ease-in-out; }
        #locations-list li:hover, #locations-list li.active { background-color: var(--primary-accent); color: white; font-weight: bold; }
        #canvas-container { flex-grow: 1; position: relative; }
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: var(--text-light); font-size: 1.2em; z-index: 100; text-align: center;
            background-color: rgba(0, 0, 0, 0.8); padding: 20px; border-radius: 8px; width: 90%; max-width: 400px;
        }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.2); border-radius: 50%; border-top: 4px solid var(--primary-accent); width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 768px) {
            #app-container { flex-direction: column; }
            #sidebar { width: 100%; height: 40%; flex-shrink: 1; }
            #canvas-container { height: 60%; }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="sidebar">
            <div id="sidebar-header"><h1>Prague Sights</h1><p>Select a destination to explore</p></div>
            <ul id="locations-list"></ul>
        </div>
        <div id="canvas-container">
            <div id="loader"><div class="spinner"></div><div id="loader-text">Loading Core Libraries...</div></div>
        </div>
    </div>
    
    <!-- BOOTLOADER SCRIPT: This will load all dependencies and then start the main application -->
    <script>
        const loaderText = document.getElementById('loader-text');
        const spinner = document.querySelector('.spinner');

        // List of libraries to load IN ORDER.
        // We use un-minified versions for max reliability, fetching from a fast, public CDN.
        const LIBRARIES = [
            'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.js',
            'https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js',
            'https://raw.githack.com/mrdoob/three.js/r128/examples/js/controls/OrbitControls.js'
        ];

        // This function fetches the text of a script and adds it to the page.
        // It returns a Promise that resolves when the script is loaded.
        function loadScript(url) {
            return fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error(`Network response was not ok for ${url}`);
                    return response.text();
                })
                .then(scriptText => {
                    const script = document.createElement('script');
                    script.textContent = scriptText;
                    document.head.appendChild(script);
                });
        }

        // Main boot-up sequence
        async function bootstrap() {
            try {
                for (const url of LIBRARIES) {
                    const libName = url.split('/').pop();
                    loaderText.textContent = `Loading ${libName}...`;
                    await loadScript(url);
                }
                loaderText.textContent = 'Libraries loaded. Starting App...';
                startApp();
            } catch (error) {
                loaderText.textContent = 'Fatal Error: Could not load libraries. ' + error.message;
                spinner.style.display = 'none';
                console.error('Bootstrap failed:', error);
            }
        }

        // The entire application is wrapped in this function.
        // It will ONLY be called after all libraries are loaded.
        function startApp() {
            try {
                const destinations = [ { name: "Prague Castle", lat: 50.0901, lon: 14.4005 }, { name: "Charles Bridge", lat: 50.0865, lon: 14.4113 }, { name: "Old Town Square", lat: 50.0874, lon: 14.4208 }, { name: "St. Vitus Cathedral", lat: 50.0909, lon: 14.4007 }, { name: "Astronomical Clock", lat: 50.0870, lon: 14.4208 }, { name: "Vyšehrad", lat: 50.0645, lon: 14.4182 }, { name: "Jewish Quarter (Josefov)", lat: 50.0906, lon: 14.4187 }, { name: "National Museum", lat: 50.0792, lon: 14.4307 }, { name: "Dancing House", lat: 50.0754, lon: 14.4140 }, { name: "Lennon Wall", lat: 50.0862, lon: 14.4072 }, { name: "Petřín Tower", lat: 50.0834, lon: 14.3949 }, { name: "Wenceslas Square", lat: 50.0809, lon: 14.4282 }, { name: "Prague Zoo", lat: 50.1171, lon: 14.4042 }, { name: "Municipal House", lat: 50.0881, lon: 14.4282 }, { name: "National Theatre", lat: 50.0811, lon: 14.4137 }, { name: "Golden Lane", lat: 50.0917, lon: 14.4037 }, { name: "Malá Strana (Lesser Town)", lat: 50.0880, lon: 14.4039 }, { name: "St. Nicholas Church (Malá Strana)", lat: 50.0880, lon: 14.4032 }, { name: "Old Royal Palace", lat: 50.0906, lon: 14.4018 }, { name: "Powder Tower", lat: 50.0873, lon: 14.4277 }, { name: "Museum of Communism", lat: 50.0869, lon: 14.4272 }, { name: "Strahov Monastery", lat: 50.0865, lon: 14.3905 }, { name: "Kampa Island", lat: 50.0847, lon: 14.4092 }, { name: "Church of Our Lady before Týn", lat: 50.0877, lon: 14.4226 }, { name: "Franz Kafka Museum", lat: 50.0878, lon: 14.4103 }, { name: "Letná Park", lat: 50.0955, lon: 14.4157 }, { name: "Clementinum", lat: 50.0865, lon: 14.4158 }, { name: "Rudolfinum", lat: 50.0898, lon: 14.4157 }, { name: "The Vrtba Garden", lat: 50.0871, lon: 14.4032 }, { name: "Speculum Alchemiae", lat: 50.0910, lon: 14.4194 }, { name: "St. George's Basilica", lat: 50.0911, lon: 14.4026 }, { name: "Old Jewish Cemetery", lat: 50.0901, lon: 14.4177 }, { name: "Náplavka Farmers Market", lat: 50.0718, lon: 14.4168 }, { name: "Žižkov Television Tower", lat: 50.0809, lon: 14.4513 }, { name: "Divoká Šárka", lat: 50.1064, lon: 14.3313 }, { name: "Španělská synagoga", lat: 50.0903, lon: 14.4206 }, { name: "Museum Kampa", lat: 50.0837, lon: 14.4087 }, { name: "Troja Palace", lat: 50.1147, lon: 14.4102 }, { name: "Prague Metronome", lat: 50.0946, lon: 14.4156 }, { name: "Henry's Tower (Jindřišská věž)", lat: 50.0842, lon: 14.4299 }, { name: "National Technical Museum", lat: 50.0984, lon: 14.4274 }, { name: "Wallenstein Palace", lat: 50.0904, lon: 14.4079 }, { name: "Infant Jesus of Prague", lat: 50.0865, lon: 14.4034 }, { name: "Slav Epic", lat: 50.0772, lon: 14.4148 }, { name: "Estates Theatre", lat: 50.0858, lon: 14.4230 }, { name: "Loreta Praha", lat: 50.0891, lon: 14.3934 }, { name: "House of the Black Madonna", lat: 50.0867, lon: 14.4258 }, { name: "Bertramka", lat: 50.0734, lon: 14.3965 }, { name: "Cross Club", lat: 50.1054, lon: 14.4690 }, { name: "Prague Planetarium", lat: 50.1042, lon: 14.4300 }];
                let scene, camera, renderer, controls, activeMarker;
                const canvasContainer = document.getElementById('canvas-container'), loader = document.getElementById('loader');
                const appLoaderText = document.getElementById('loader-text');
                const MAP_CENTER = { lat: 50.0874, lon: 14.4208 };
                
                async function loadMapData() { 
                    try { 
                        appLoaderText.textContent = `Loading 3D Map...`;
                        const response = await fetch('prague_buildings.geojson'); 
                        if (!response.ok) throw new Error(`HTTP ${response.status} fetching GeoJSON`); 
                        const data = await response.json(); 
                        appLoaderText.textContent = `Processing ${data.features.length} buildings...`;
                        // Give the browser a moment to render the text update before a potentially long process
                        await new Promise(resolve => setTimeout(resolve, 50)); 
                        processGeoJson(data); 
                    } catch (error) { 
                        appLoaderText.textContent = `Error: ${error.message}.`; 
                        spinner.style.display = 'none'; 
                    } 
                }

                function init() { 
                    scene = new THREE.Scene(); 
                    scene.background = new THREE.Color(getComputedStyle(document.documentElement).getPropertyValue('--bg-dark')); 
                    camera = new THREE.PerspectiveCamera(60, canvasContainer.clientWidth/canvasContainer.clientHeight, 0.1, 5000); 
                    camera.position.set(0, 500, 500); 
                    
                    renderer = new THREE.WebGLRenderer({ antialias: true }); 
                    renderer.setPixelRatio(window.devicePixelRatio); 
                    renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight); 
                    renderer.shadowMap.enabled = true; 
                    canvasContainer.appendChild(renderer.domElement); 
                    
                    // Using OrbitControls - simpler and more reliable
                    controls = new THREE.OrbitControls(camera, renderer.domElement); 
                    controls.enableDamping = true; 
                    controls.dampingFactor = 0.05; 
                    controls.minDistance = 50; 
                    controls.maxDistance = 2000; 
                    controls.maxPolarAngle = Math.PI / 2.2; 
                    
                    const ambientLight = new THREE.AmbientLight(0xffffff, 0.7); 
                    scene.add(ambientLight); 
                    const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0); 
                    directionalLight.position.set(-300, 800, 500); 
                    directionalLight.castShadow = true; 
                    scene.add(directionalLight); 
                    
                    const groundGeo = new THREE.PlaneGeometry(5000, 5000); 
                    const groundMat = new THREE.MeshStandardMaterial({ color: getComputedStyle(document.documentElement).getPropertyValue('--ground-color') }); 
                    const ground = new THREE.Mesh(groundGeo, groundMat); 
                    ground.rotation.x = -Math.PI/2; 
                    ground.receiveShadow = true; 
                    scene.add(ground); 
                    
                    populateLocationsList(); 
                    loadMapData(); 
                    window.addEventListener('resize', onWindowResize, false); 
                    animate(); 
                }

                function processGeoJson(geojson) { 
                    const buildingMaterial = new THREE.MeshStandardMaterial({ color: getComputedStyle(document.documentElement).getPropertyValue('--building-color'), metalness: 0.3, roughness: 0.6 }); 
                    geojson.features.forEach(feature => { if (feature.geometry) addBuilding(feature); }); 
                    loader.style.display = 'none'; 
                    function addBuilding(feature) { 
                        const geomType = feature.geometry.type, coords = feature.geometry.coordinates, properties = feature.properties; 
                        let height = properties.height || (properties['building:levels'] ? properties['building:levels'] * 3.5 : 10 + Math.random() * 20); 
                        const shapeFromCoords = (polygon) => { const shape = new THREE.Shape(); try { const firstPoint = mercatorProjection(polygon[0][0], polygon[0][1]); shape.moveTo(firstPoint.x, firstPoint.z); for (let i = 1; i < polygon.length; i++) { const point = mercatorProjection(polygon[i][0], polygon[i][1]); shape.lineTo(point.x, point.z); } return shape; } catch (e) { return null; } }; 
                        const createMesh = (shape) => { if (!shape) return; const extrudeSettings = { steps: 1, depth: height, bevelEnabled: false }; const geometry = new THREE.ExtrudeGeometry(shape, extrudeSettings); const building = new THREE.Mesh(geometry, buildingMaterial); building.castShadow = true; building.receiveShadow = true; scene.add(building); }; 
                        if (geomType === 'Polygon') { createMesh(shapeFromCoords(coords[0])); } else if (geomType === 'MultiPolygon') { coords.forEach(polygon => createMesh(shapeFromCoords(polygon[0]))); } 
                    } 
                }

                function populateLocationsList() { const list = document.getElementById('locations-list'); destinations.forEach((dest, index) => { const li = document.createElement('li'); li.textContent = dest.name; li.dataset.index = index; li.addEventListener('click', onLocationClick); list.appendChild(li); }); }
                function onLocationClick(event) { document.querySelectorAll('#locations-list li').forEach(item => item.classList.remove('active')); event.target.classList.add('active'); const destination = destinations[event.target.dataset.index]; flyTo(destination); }
                function flyTo(destination) { 
                    const targetPos = mercatorProjection(destination.lon, destination.lat); 
                    const cameraTargetPos = { x: targetPos.x, y: 200, z: targetPos.z + 300 }; 
                    if (!activeMarker) { 
                        const markerGeo = new THREE.CylinderGeometry(8, 0, 30, 8); 
                        const markerMat = new THREE.MeshStandardMaterial({ color: getComputedStyle(document.documentElement).getPropertyValue('--primary-accent'), emissive: getComputedStyle(document.documentElement).getPropertyValue('--primary-accent'), emissiveIntensity: 0.5 }); 
                        activeMarker = new THREE.Mesh(markerGeo, markerMat); 
                        activeMarker.position.y = 15; 
                        scene.add(activeMarker); 
                    } 
                    activeMarker.position.x = targetPos.x; 
                    activeMarker.position.z = targetPos.z; 
                    activeMarker.visible = true; 
                    new TWEEN.Tween(camera.position).to(cameraTargetPos, 2000).easing(TWEEN.Easing.Cubic.InOut).start(); 
                    new TWEEN.Tween(controls.target).to({ x: targetPos.x, y: 0, z: targetPos.z }, 2000).easing(TWEEN.Easing.Cubic.InOut).start(); 
                }
                function mercatorProjection(lon, lat) { const R = 6378137, scale = 0.5; const x = R * (lon * Math.PI / 180 - MAP_CENTER.lon * Math.PI / 180) * scale; const y = R * Math.log(Math.tan(Math.PI / 4 + lat * Math.PI / 180 / 2)) * scale; const center_y = R * Math.log(Math.tan(Math.PI / 4 + MAP_CENTER.lat * Math.PI / 180 / 2)) * scale; return { x: x, z: -(y - center_y) }; }
                function onWindowResize() { camera.aspect = canvasContainer.clientWidth / canvasContainer.clientHeight; camera.updateProjectionMatrix(); renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight); }
                function animate() { requestAnimationFrame(animate); TWEEN.update(); controls.update(); renderer.render(scene, camera); }
                
                init();

            } catch (e) {
                document.getElementById('loader-text').textContent = 'An application error occurred: ' + e.message;
                spinner.style.display = 'none';
                console.error('App failed:', e);
            }
        }

        // Start the bootloader
        bootstrap();

    </script>
</body>
</html>
