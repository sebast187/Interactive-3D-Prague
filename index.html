<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Interactive 3D Prague</title>
    <style>
        :root {
            --bg-dark: #121212; --sidebar-bg: #1e1e1e; --primary-accent: #e94560;
            --text-light: #f0f0f0; --text-muted: #a0a0a0; --ground-color: #2a2a2a;
            --building-color: #555555; --building-highlight: #e94560; --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --error-color: #ff6b6b; --ok-color: #4CAF50;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100dvh; overflow: hidden; font-family: var(--font-main); background-color: var(--bg-dark); color: var(--text-light); }
        #app-container { display: flex; width: 100%; height: 100%; }
        #sidebar { width: 300px; flex-shrink: 0; background-color: var(--sidebar-bg); display: flex; flex-direction: column; box-shadow: 2px 0 15px rgba(0,0,0,0.5); z-index: 10; }
        #sidebar-header { padding: 20px; border-bottom: 1px solid #333; }
        #sidebar-header h1 { color: var(--primary-accent); font-size: 1.5em; margin-bottom: 5px; }
        #sidebar-header p { color: var(--text-muted); font-size: 0.9em; }
        #locations-list { list-style: none; overflow-y: auto; flex-grow: 1; }
        #locations-list li { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #333; transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; color: var(--text-light); }
        #locations-list li:hover, #locations-list li.active { background-color: var(--primary-accent); color: white; }
        #canvas-container { flex-grow: 1; position: relative; }
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: var(--text-light); font-size: 1.2em; z-index: 100; text-align: center;
            background-color: rgba(0, 0, 0, 0.8); padding: 20px; border-radius: 8px; width: 90%; max-width: 500px;
        }
        #loader-text { margin-bottom: 15px; }
        #debug-log { font-family: monospace; font-size: 0.8em; text-align: left; max-height: 200px; overflow-y: auto; background: #000; padding: 10px; border-radius: 4px; }
        #debug-log p { margin-bottom: 5px; }
        #debug-log .error { color: var(--error-color); font-weight: bold; }
        #debug-log .ok { color: var(--ok-color); }
        @media (max-width: 768px) {
            #app-container { flex-direction: column; }
            #sidebar { width: 100%; height: 40%; flex-shrink: 1; }
            #canvas-container { height: 60%; }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="sidebar">
            <div id="sidebar-header">
                <h1>Prague Sights</h1>
                <p>Select a destination to explore</p>
            </div>
            <ul id="locations-list"></ul>
        </div>
        <div id="canvas-container">
            <div id="loader">
                <div id="loader-text">Loading 3D Map...</div>
                <div id="debug-log"></div>
            </div>
        </div>
    </div>
    
    <!-- LIBRARIES (Standard, non-module versions) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/MapControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tween.js@18.6.4/dist/tween.umd.js"></script>

    <!-- MAIN APPLICATION SCRIPT (no type="module") -->
    <script>
    // --- STEP 0: THE MOST BASIC DEBUGGING ---
    const debugLog = document.getElementById('debug-log');
    function logToScreen(message, type = '') {
        console.log(message);
        const p = document.createElement('p');
        p.textContent = message;
        if (type) p.classList.add(type);
        debugLog.appendChild(p);
        debugLog.scrollTop = debugLog.scrollHeight;
    }

    try {
        logToScreen('1. Main script block has started execution.');

        // --- Check if libraries loaded ---
        if (typeof THREE === 'undefined') throw new Error("FATAL: THREE.js library failed to load.");
        logToScreen('2. OK: THREE.js is loaded.', 'ok');
        if (typeof THREE.MapControls === 'undefined') throw new Error("FATAL: MapControls.js failed to load.");
        logToScreen('3. OK: MapControls.js is loaded.', 'ok');
        if (typeof TWEEN === 'undefined') throw new Error("FATAL: TWEEN.js failed to load.");
        logToScreen('4. OK: TWEEN.js is loaded.', 'ok');

        // --- DATA: Top Tourist Destinations ---
        const destinations = [ { name: "Prague Castle", lat: 50.0901, lon: 14.4005 }, { name: "Charles Bridge", lat: 50.0865, lon: 14.4113 }, { name: "Old Town Square", lat: 50.0874, lon: 14.4208 }, { name: "St. Vitus Cathedral", lat: 50.0909, lon: 14.4007 }, { name: "Astronomical Clock", lat: 50.0870, lon: 14.4208 }, { name: "Vyšehrad", lat: 50.0645, lon: 14.4182 }, { name: "Jewish Quarter (Josefov)", lat: 50.0906, lon: 14.4187 }, { name: "National Museum", lat: 50.0792, lon: 14.4307 }, { name: "Dancing House", lat: 50.0754, lon: 14.4140 }, { name: "Lennon Wall", lat: 50.0862, lon: 14.4072 }, { name: "Petřín Tower", lat: 50.0834, lon: 14.3949 }, { name: "Wenceslas Square", lat: 50.0809, lon: 14.4282 }, { name: "Prague Zoo", lat: 50.1171, lon: 14.4042 }, { name: "Municipal House", lat: 50.0881, lon: 14.4282 }, { name: "National Theatre", lat: 50.0811, lon: 14.4137 }, { name: "Golden Lane", lat: 50.0917, lon: 14.4037 }, { name: "Malá Strana (Lesser Town)", lat: 50.0880, lon: 14.4039 }, { name: "St. Nicholas Church (Malá Strana)", lat: 50.0880, lon: 14.4032 }, { name: "Old Royal Palace", lat: 50.0906, lon: 14.4018 }, { name: "Powder Tower", lat: 50.0873, lon: 14.4277 }, { name: "Museum of Communism", lat: 50.0869, lon: 14.4272 }, { name: "Strahov Monastery", lat: 50.0865, lon: 14.3905 }, { name: "Kampa Island", lat: 50.0847, lon: 14.4092 }, { name: "Church of Our Lady before Týn", lat: 50.0877, lon: 14.4226 }, { name: "Franz Kafka Museum", lat: 50.0878, lon: 14.4103 }, { name: "Letná Park", lat: 50.0955, lon: 14.4157 }, { name: "Clementinum", lat: 50.0865, lon: 14.4158 }, { name: "Rudolfinum", lat: 50.0898, lon: 14.4157 }, { name: "The Vrtba Garden", lat: 50.0871, lon: 14.4032 }, { name: "Speculum Alchemiae", lat: 50.0910, lon: 14.4194 }, { name: "St. George's Basilica", lat: 50.0911, lon: 14.4026 }, { name: "Old Jewish Cemetery", lat: 50.0901, lon: 14.4177 }, { name: "Náplavka Farmers Market", lat: 50.0718, lon: 14.4168 }, { name: "Žižkov Television Tower", lat: 50.0809, lon: 14.4513 }, { name: "Divoká Šárka", lat: 50.1064, lon: 14.3313 }, { name: "Španělská synagoga", lat: 50.0903, lon: 14.4206 }, { name: "Museum Kampa", lat: 50.0837, lon: 14.4087 }, { name: "Troja Palace", lat: 50.1147, lon: 14.4102 }, { name: "Prague Metronome", lat: 50.0946, lon: 14.4156 }, { name: "Henry's Tower (Jindřišská věž)", lat: 50.0842, lon: 14.4299 }, { name: "National Technical Museum", lat: 50.0984, lon: 14.4274 }, { name: "Wallenstein Palace", lat: 50.0904, lon: 14.4079 }, { name: "Infant Jesus of Prague", lat: 50.0865, lon: 14.4034 }, { name: "Slav Epic", lat: 50.0772, lon: 14.4148 }, { name: "Estates Theatre", lat: 50.0858, lon: 14.4230 }, { name: "Loreta Praha", lat: 50.0891, lon: 14.3934 }, { name: "House of the Black Madonna", lat: 50.0867, lon: 14.4258 }, { name: "Bertramka", lat: 50.0734, lon: 14.3965 }, { name: "Cross Club", lat: 50.1054, lon: 14.4690 }, { name: "Prague Planetarium", lat: 50.1042, lon: 14.4300 }];
        
        let scene, camera, renderer, controls;
        let activeMarker;
        const canvasContainer = document.getElementById('canvas-container');
        const loader = document.getElementById('loader');
        
        const MAP_CENTER = { lat: 50.0874, lon: 14.4208 };

        async function loadMapData() {
            logToScreen('5. Starting map data load...');
            try {
                const geoJsonPath = 'prague_buildings.geojson';
                const response = await fetch(geoJsonPath);
                logToScreen(`6. Fetch completed. Status: ${response.status} ${response.statusText}`, response.ok ? 'ok' : 'error');
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                logToScreen('7. Parsing file as JSON...');
                const data = await response.json();
                if (!data || !data.features) throw new Error("JSON is invalid or has no 'features' array.");
                logToScreen(`8. OK: Found ${data.features.length} features.`, 'ok');
                processGeoJson(data);
            } catch (error) {
                logToScreen(`>>> ERROR in loadMapData: ${error.message}`, 'error');
                document.getElementById('loader-text').textContent = "Failed to load map.";
            }
        }

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(getComputedStyle(document.documentElement).getPropertyValue('--bg-dark'));
            camera = new THREE.PerspectiveCamera(60, canvasContainer.clientWidth / canvasContainer.clientHeight, 0.1, 5000);
            camera.position.set(0, 500, 500);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
            canvasContainer.appendChild(renderer.domElement);
            controls = new THREE.MapControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
            directionalLight.position.set(-300, 800, 500);
            scene.add(directionalLight);
            const groundGeo = new THREE.PlaneGeometry(5000, 5000);
            const groundMat = new THREE.MeshStandardMaterial({ color: getComputedStyle(document.documentElement).getPropertyValue('--ground-color') });
            const ground = new THREE.Mesh(groundGeo, groundMat);
            ground.rotation.x = -Math.PI / 2;
            scene.add(ground);
            populateLocationsList();
            loadMapData();
            window.addEventListener('resize', () => {
                camera.aspect = canvasContainer.clientWidth / canvasContainer.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
            }, false);
            animate();
        }
        function processGeoJson(geojson) {
            logToScreen('9. Building 3D models...');
            const buildingMaterial = new THREE.MeshStandardMaterial({ color: getComputedStyle(document.documentElement).getPropertyValue('--building-color'), metalness: 0.3, roughness: 0.6 });
            for (const feature of geojson.features) { if (!feature.geometry) continue; const geomType = feature.geometry.type; const coords = feature.geometry.coordinates; if (geomType === 'Polygon') { addBuilding(coords, feature.properties, buildingMaterial); } else if (geomType === 'MultiPolygon') { coords.forEach(polygonCoords => { addBuilding(polygonCoords, feature.properties, buildingMaterial); }); } }
            loader.style.display = 'none';
        }
        function addBuilding(coords, properties, material) { let height = properties.height || (properties['building:levels'] ? properties['building:levels'] * 3.5 : 10 + Math.random() * 20); const shape = new THREE.Shape(); const firstPoint = mercatorProjection(coords[0][0][0], coords[0][0][1]); shape.moveTo(firstPoint.x, firstPoint.z); for (let i = 1; i < coords[0].length; i++) { const point = mercatorProjection(coords[0][i][0], coords[0][i][1]); shape.lineTo(point.x, point.z); } const extrudeSettings = { steps: 1, depth: height, bevelEnabled: false }; const geometry = new THREE.ExtrudeGeometry(shape, extrudeSettings); const building = new THREE.Mesh(geometry, material); scene.add(building); }
        function populateLocationsList() { const list = document.getElementById('locations-list'); destinations.forEach((dest, index) => { const li = document.createElement('li'); li.textContent = dest.name; li.dataset.index = index; li.addEventListener('click', (event) => { document.querySelectorAll('#locations-list li').forEach(item => item.classList.remove('active')); event.target.classList.add('active'); const destination = destinations[event.target.dataset.index]; flyTo(destination); }); list.appendChild(li); }); }
        function flyTo(destination) { const targetPos = mercatorProjection(destination.lon, destination.lat); const cameraTargetPos = { x: targetPos.x, y: 200, z: targetPos.z + 300 }; if(!activeMarker){ const markerGeo = new THREE.CylinderGeometry(8, 0, 30, 8); const markerMat = new THREE.MeshStandardMaterial({ color: getComputedStyle(document.documentElement).getPropertyValue('--primary-accent') }); activeMarker = new THREE.Mesh(markerGeo, markerMat); activeMarker.position.y = 15; scene.add(activeMarker); } activeMarker.position.x = targetPos.x; activeMarker.position.z = targetPos.z; activeMarker.visible = true; new TWEEN.Tween(camera.position).to(cameraTargetPos, 2000).easing(TWEEN.Easing.Cubic.InOut).start(); new TWEEN.Tween(controls.target).to({ x: targetPos.x, y: 0, z: targetPos.z }, 2000).easing(TWEEN.Easing.Cubic.InOut).start(); }
        function mercatorProjection(lon, lat) { const R = 6378137; const scale = 0.5; const x = R * (lon * Math.PI / 180 - MAP_CENTER.lon * Math.PI / 180) * scale; const y = R * Math.log(Math.tan(Math.PI / 4 + (lat * Math.PI / 180) / 2)) * scale; const center_y = R * Math.log(Math.tan(Math.PI / 4 + (MAP_CENTER.lat * Math.PI / 180) / 2)) * scale; return { x: x, z: -(y - center_y) }; }
        function animate() { requestAnimationFrame(animate); TWEEN.update(); controls.update(); renderer.render(scene, camera); }

        init();
        logToScreen('--- Initialization complete ---');

    } catch (e) {
        logToScreen(e.message, 'error');
        document.getElementById('loader-text').textContent = "A critical error occurred.";
    }
    </script>
</body>
</html>
</html>
